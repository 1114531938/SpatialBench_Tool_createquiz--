# QA构造工具 (QA Constructor Tool)

一个用于创建和编辑多视角视频问答（Video QA）数据集的标注工具。

## 📋 目录

- [功能特性](#功能特性)
- [快速开始](#快速开始)
- [数据结构](#数据结构)
- [使用指南](#使用指南)
- [功能详解](#功能详解)
- [配置说明](#配置说明)
- [常见问题](#常见问题)

---

## ✨ 功能特性

### 核心功能

- **多视角视频支持** - 支持单视角和多视角视频的问答标注
- **实时视频预览** - 边看视频边标注，支持视角切换和播放
- **完整QA编辑** - 问题、选项、答案、时间点等全要素编辑
- **自动保存** - 所有修改自动保存到JSON文件
- **问题质量管理** - 标记无效问题并记录原因
- **版本管理** - 自动标记新增QA版本信息

### 高级特性

- **三栏视角管理** - 所有视角列表、主视角、提问视角分栏展示
- **视角快速切换** - 点击视角名称立即切换播放器
- **分段播放** - 支持播放前半段（start→cut_point）和后半段（cut_point→end）
- **时间点设置** - 一键设置当前播放时间为cut_point或提问视角时间
- **问题类型** - 支持8种问题类型（Planning、Relation、Distance等）
- **时间方向** - 支持forward和backward两种时间推理方向

---

## 🚀 快速开始

### 环境要求

- Python 3.7+
- Flask 2.0+
- 现代浏览器（Chrome、Edge、Firefox等）

### 安装步骤

1. **克隆或下载项目**
   ```bash
   cd SpatialBench_Tool_createquiz
   ```

2. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

3. **配置视频路径**
   
   编辑 `config.py` 文件，设置视频根目录：
   ```python
   VIDEO_BASE_PATH = r"D:\your\video\path"
   ```

4. **准备数据文件**
   
   在 `data/` 目录下准备JSON文件（或使用示例文件 `test_clean.json`）

5. **启动服务**
   ```bash
   python app.py
   ```

6. **打开浏览器**
   
   访问 `http://127.0.0.1:5000/qa-constructor`

---

## 📊 数据结构

### JSON文件格式

QA数据以video为单位组织，每个video包含多个QA：

```json
{
  "video_name_1": [
    {
      "qa_id": "video_name_1_qa_0",
      "video_name": "video_name_1",
      "主视角": ["cam01.mp4", "cam02.mp4"],
      "提问视角": ["cam03.mp4"],
      "提问视角_time": "00:57.00",
      "question": "问题文本",
      "options": ["选项A", "选项B", "选项C", "选项D"],
      "ground_truth": "选项A",
      "question_type": "Planning",
      "temporal_direction": "forward",
      "start_time": "00:00.00",
      "end_time": "00:10.00",
      "cut_point": "00:05.00",
      "usable": true,
      "useless_reason": "",
      "version": "v2"
    }
  ],
  "video_name_2": [...]
}
```

### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `qa_id` | string | ✅ | QA唯一标识符 |
| `video_name` | string | ✅ | 视频名称（不含扩展名） |
| `主视角` | array | ❌ | 主视角列表，用于对比和参考 |
| `提问视角` | array | ❌ | 提问视角，提问基于此视角 |
| `提问视角_time` | string | ❌ | 提问视角的关键时间点（HH:MM:SS） |
| `question` | string | ✅ | 问题文本 |
| `options` | array | ✅ | 选项列表 |
| `ground_truth` | string | ✅ | 正确答案 |
| `question_type` | string | ✅ | 问题类型（见下表） |
| `temporal_direction` | string | ✅ | 时间方向（forward/backward） |
| `start_time` | string | ✅ | 视频开始时间（MM:SS.XX） |
| `end_time` | string | ✅ | 视频结束时间（MM:SS.XX） |
| `cut_point` | string | ❌ | 时间分割点（MM:SS.XX） |
| `usable` | boolean | ✅ | 问题是否有效 |
| `useless_reason` | string | ❌ | 无效原因（当usable=false时） |
| `version` | string | ✅ | 版本标识（新增默认v2） |

### 问题类型 (question_type)

| 类型 | 说明 |
|------|------|
| Planning | 规划类问题 |
| Relation | 关系类问题 |
| Relative Distance | 相对距离问题 |
| Appearance Order | 出现顺序问题 |
| Relative Size | 相对大小问题 |
| Spatial State | 空间状态问题 |
| Relative Speed | 相对速度问题 |
| Counting | 计数类问题 |

### 无效原因 (useless_reason)

当 `usable = false` 时，必须选择以下原因之一：

- 问题类型错误
- 问题视角不明晰
- 问题本身有问题
- 时间区间不恰当
- 选项不恰当
- 无法作答彻底舍弃

---

## 📖 使用指南

### 1. 加载数据

1. 在左上角选择JSON文件
2. 点击"加载"按钮
3. 视频列表将显示在左侧边栏

### 2. 创建新QA

1. 展开某个video
2. 点击"+ 添加新QA"按钮
3. 系统自动生成QA ID并打开编辑界面

### 3. 编辑QA

#### 3.1 视频播放

- **加载视频**: 选择主视角或提问视角自动加载
- **切换视角**: 点击不同视角名称切换播放
- **分段播放**: 
  - "播放前半段"：从start_time播放到cut_point
  - "播放后半段"：从cut_point播放到end_time

#### 3.2 视角管理

**所有视角栏**（左）:
- 显示该video的所有可用视角
- 点击视角 → 弹出对话框：
  - 立即播放此视角（临时）
  - 添加到主视角
  - 设置为提问视角

**主视角栏**（中）:
- 显示已添加的主视角
- 点击视角名称：切换播放
- 点击"移除"：从主视角移除

**提问视角栏**（右）:
- 显示提问视角
- 点击视角名称：切换播放
- 点击"移除"：清除提问视角

#### 3.3 时间点设置

1. 播放视频到目标时间
2. 点击"设置为cut_point"或"设置为提问视角时间"
3. 当前时间自动填入对应字段

#### 3.4 问题编辑

- **问题文本**: 在"问题"文本框中输入
- **问题类型**: 从8种类型中选择
- **时间方向**: 选择forward或backward
- **选项**: 
  - 点击"+ 添加选项"
  - 填写选项内容
  - 点击"×"删除选项
- **答案**: 填写ground_truth（应与某个选项一致）

#### 3.5 问题有效性

- **有效问题**: 选择"有效(true)"，无效原因自动隐藏
- **无效问题**: 
  1. 选择"无效(false)"
  2. 从下拉框选择无效原因
  3. 自动保存

### 4. 删除QA

1. 滚动到底部
2. 点击"删除此QA"按钮
3. 确认删除

### 5. 保存数据

- **自动保存**: 所有修改自动保存到JSON文件
- **无需手动保存**: 修改立即生效

---

## 🎯 功能详解

### 多视角管理

#### 概念说明

- **主视角**: 用于观看和参考的视角列表，可以添加多个，便于对比
- **提问视角**: 问题基于的特定视角，通常只有一个
- **独立性**: 主视角和提问视角完全独立，互不影响

#### 使用场景

**场景1: 多视角对比**
```
1. 添加cam01.mp4、cam02.mp4、cam03.mp4到主视角
2. 播放视频到关键时刻
3. 点击不同视角对比同一时刻的不同角度
4. 设置cam02.mp4为提问视角
5. 基于cam02的视角撰写问题
```

**场景2: 快速预览**
```
1. 点击"所有视角"中的任意视角
2. 选择"立即播放此视角"
3. 快速查看但不保存
4. 决定后再添加到主视角或提问视角
```

### 时间管理

#### 时间点类型

1. **start_time**: 视频片段开始时间
2. **end_time**: 视频片段结束时间
3. **cut_point**: 关键分割点，用于分段播放
4. **提问视角_time**: 提问视角的关键帧时间

#### 格式要求

- **MM:SS.XX**: 分钟:秒.百分秒（如 01:23.45）
- **HH:MM:SS**: 时:分:秒（如 00:01:23，用于提问视角_time）

### 问题质量控制

#### 质量标记流程

```
标注员创建QA (usable=true)
        ↓
审核员检查发现问题
        ↓
标记为无效 (usable=false)
        ↓
选择无效原因（6选1）
        ↓
标注员查看原因并修改
        ↓
改回有效 (usable=true)
```

#### 统计分析

可以按 `useless_reason` 统计常见问题：
```python
# 统计示例
无效原因分布:
- 问题类型错误: 15个
- 问题视角不明晰: 8个
- 问题本身有问题: 23个
- 时间区间不恰当: 5个
- 选项不恰当: 12个
- 无法作答彻底舍弃: 3个
```

---

## ⚙️ 配置说明

### config.py

```python
# 视频文件根目录
VIDEO_BASE_PATH = r"D:\your\video\path"

# 数据文件目录
DATA_DIR = "data"

# 服务器配置
HOST = "127.0.0.1"
PORT = 5000
DEBUG = True
```

### 目录结构

```
SpatialBench_Tool_createquiz/
├── app.py                      # Flask应用主文件
├── config.py                   # 配置文件
├── requirements.txt            # Python依赖
├── README.md                   # 本文件
├── models/                     # 后端逻辑
│   ├── qa_constructor_manager.py  # QA管理器
│   └── video_path_manager.py      # 视频路径管理
├── templates/                  # HTML模板
│   └── qa_constructor.html     # 主界面模板
├── static/                     # 静态资源
│   └── js/
│       └── qa_constructor.js   # 前端逻辑
└── data/                       # 数据文件
    ├── test_clean.json         # 示例数据
    └── your_data.json          # 你的数据
```

---

## 🎨 界面说明

### 左侧边栏

```
┌─────────────────────┐
│ [选择JSON文件 ▼]    │
│ [加载]              │
├─────────────────────┤
│ 📊 总计: 3个video   │
│    总计: 5个QA      │
├─────────────────────┤
│ 📹 Video列表        │
│ ▼ youtube_009 (2)   │
│   ├─ QA 1           │
│   ├─ QA 2           │
│   └─ + 添加新QA     │
│ ▼ cmu_bike10_2 (1)  │
│   ├─ QA 1           │
│   └─ + 添加新QA     │
└─────────────────────┘
```

### 主编辑区

```
┌──────────────────────────────────────┐
│ 🎬 视频播放器                         │
│ ┌────────────────────────────────┐  │
│ │    [视频画面]                   │  │
│ └────────────────────────────────┘  │
│ 当前: 00:05.23                       │
│ [设置为cut_point] [设置为提问时间]   │
│ [播放前半段] [播放后半段]            │
├──────────────────────────────────────┤
│ 🎥 视角管理（三栏）                   │
│ ┌──────┬──────┬──────┐             │
│ │所有  │主视角│提问  │             │
│ │视角  │      │视角  │             │
│ └──────┴──────┴──────┘             │
├──────────────────────────────────────┤
│ ℹ️ 基本信息                          │
│ QA ID: [自动生成]                    │
│ Video: [自动填充]                    │
│ 问题: [文本框]                       │
│ 问题类型: [下拉选择]                 │
│ ...                                  │
├──────────────────────────────────────┤
│ 📝 选项                              │
│ [+ 添加选项]                         │
├──────────────────────────────────────┤
│ ✅ 答案                              │
│ Ground Truth: [输入框]               │
├──────────────────────────────────────┤
│ ☑️ 问题有效性                        │
│ 有效性: [有效▼]                      │
│ 无效原因: [隐藏]                     │
├──────────────────────────────────────┤
│ [🗑️ 删除此QA]                        │
└──────────────────────────────────────┘
```

---

## ❓ 常见问题

### Q1: 视频加载失败怎么办？

**A**: 检查以下几点：
1. `config.py` 中的 `VIDEO_BASE_PATH` 是否正确
2. 视频文件是否存在
3. 视频文件名是否与JSON中的视角名称一致
4. 浏览器是否支持该视频格式（推荐MP4）

### Q2: 修改没有保存？

**A**: 所有修改都是自动保存的，如果没有保存：
1. 检查浏览器控制台（F12）是否有错误
2. 检查JSON文件是否有写入权限
3. 刷新页面重新加载数据

### Q3: 如何批量导入视频？

**A**: 
1. 准备好JSON文件，按照数据结构填写
2. 将视频文件按照命名规则放入视频目录
3. 视频目录结构：`VIDEO_BASE_PATH/video_name/perspective.mp4`

### Q4: 提问视角和主视角的区别？

**A**:
- **主视角**: 用于观看和对比的多个视角，可以添加多个
- **提问视角**: 问题基于的特定视角，通常只有一个
- **独立性**: 两者完全独立，从主视角移除不影响提问视角

### Q5: 如何快速标注？

**A**: 推荐工作流：
1. 先快速预览所有视角（点击"所有视角"→"立即播放"）
2. 选择合适的视角添加到主视角
3. 设置提问视角
4. 播放视频，一键设置时间点
5. 填写问题和选项
6. 自动保存

### Q6: 时间格式错误怎么办？

**A**: 请严格按照格式要求：
- `start_time`, `end_time`, `cut_point`: `MM:SS.XX` (如 01:23.45)
- `提问视角_time`: `HH:MM:SS` (如 00:01:23)
- 使用"设置为..."按钮可以自动填充正确格式

### Q7: 如何导出数据？

**A**: JSON文件即为最终数据，可以直接复制使用：
- 位置: `data/your_file.json`
- 格式: 标准JSON，可直接用于训练或评估

### Q8: 支持哪些浏览器？

**A**: 推荐使用：
- ✅ Chrome 90+
- ✅ Edge 90+
- ✅ Firefox 88+
- ⚠️ Safari（可能存在兼容性问题）

---

## 📞 技术支持

如有问题，请检查：
1. 浏览器控制台（F12 → Console）是否有错误
2. Python终端是否有错误输出
3. JSON文件格式是否正确

---

## 📝 更新日志

### v4.6 (2025-01-12)
- ✅ 添加问题有效性标记（usable & useless_reason）
- ✅ 无效原因改为下拉选择（6个预设选项）
- ✅ 主视角和提问视角完全独立

### v4.5
- ✅ 所有视角栏支持直接播放
- ✅ 修复提问视角添加功能

### v4.0
- ✅ 改为video分组管理（原segment分组）
- ✅ 三栏视角管理
- ✅ 视角播放切换功能
- ✅ 字段统一（移除冗余"视角"字段）

### v3.0
- ✅ 多视角支持
- ✅ 分段播放功能
- ✅ 时间点快速设置

### v2.0
- ✅ 基础QA编辑功能
- ✅ 自动保存
- ✅ 视频播放

---

## 📄 许可证

本项目仅供学术研究使用。

---

**祝标注顺利！🎉**


